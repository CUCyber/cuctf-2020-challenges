FROM ubuntu:focal

ENV DEBIAN_FRONTEND noninteractive

RUN apt-get update --fix-missing && \
    apt-get -y upgrade && \
    apt-get install -y --no-install-recommends \
        iproute2 \
        jq \
        lib32z1 \
        libseccomp-dev \
        python3 \
        qemu-system-x86 \
        udhcpd \
        xinetd \
    && apt-get clean

RUN groupadd -r ctf && \
    useradd -r -g ctf ctf && \
    mkdir /home/ctf

ADD config/ctf.xinetd /etc/xinetd.d/ctf
ADD config/run_xinetd.sh /etc/run_xinetd.sh
ADD config/run_challenge.sh /home/ctf/run_challenge.sh

ADD challenge /home/ctf/

RUN chmod -R 750 /home/ctf/ && \
    chown -R ctf:ctf /home/ctf && \
    chmod 700 /etc/run_xinetd.sh

RUN service xinetd restart
