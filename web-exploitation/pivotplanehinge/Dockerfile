FROM golang:1.14 AS build-env

# Use vendored Go modules.
ENV GOFLAGS=-mod=vendor

# Build the server binary.
WORKDIR /go/src/pivotplanehinge/server
COPY server /go/src/pivotplanehinge/server

RUN go get github.com/gorilla/websocket
RUN CGO_ENABLED=0 GOOS=linux go build .

FROM alpine:3.12

RUN apk --no-cache add ca-certificates tzdata
WORKDIR /app
COPY --from=build-env /go/src/pivotplanehinge/server /app/

RUN addgroup -g 1337 -S appuser && \
    adduser -u 1337 -S appuser -G appuser && \
    chown -R appuser:appuser /app
USER appuser

EXPOSE 8079

CMD ["/app/server"]
